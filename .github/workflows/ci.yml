name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'algorithms/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'algorithms/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Lint and format checks
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flake8 black isort
      
      - name: Check formatting with black
        run: |
          black --check . || echo "::warning::Code formatting issues found. Run 'black .' to fix."
        continue-on-error: true
      
      - name: Check imports with isort
        run: |
          isort --check-only . || echo "::warning::Import order issues found. Run 'isort .' to fix."
        continue-on-error: true
      
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

  # Build and test
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install numpy scipy sympy matplotlib pytest
          pip install brotli zstandard

      # === IP Pillar 1: RFT Transform Unitarity ===
      - name: "Test: RFT Unitarity (roundtrip < 1e-14)"
        run: |
          python -c "
          from algorithms.rft.core.canonical_true_rft import CanonicalTrueRFT
          import numpy as np
          rft = CanonicalTrueRFT(256)
          x = np.random.randn(256) + 1j*np.random.randn(256)
          y = rft.forward_transform(x)
          x_rec = rft.inverse_transform(y)
          err = np.linalg.norm(x - x_rec) / np.linalg.norm(x)
          assert err < 1e-14, f'Unitarity failed: {err:.2e}'
          print(f'✓ RFT Unitarity: {err:.2e}')
          "

      # === IP Pillar 2: RFT ≠ FFT (Non-equivalence) ===
      - name: "Test: RFT is NOT equivalent to FFT"
        run: |
          python -c "
          from algorithms.rft.core.canonical_true_rft import CanonicalTrueRFT
          import numpy as np
          from numpy.fft import fft
          np.random.seed(42)
          N = 256
          x = np.random.randn(N) + 1j * np.random.randn(N)
          rft = CanonicalTrueRFT(N)
          y_rft = rft.forward_transform(x)
          y_fft = fft(x, norm='ortho')
          corr = np.abs(np.vdot(y_rft, y_fft)) / (np.linalg.norm(y_rft) * np.linalg.norm(y_fft))
          assert corr < 0.5, f'RFT should NOT correlate with FFT: {corr:.4f}'
          print(f'✓ RFT ≠ FFT: correlation={corr:.4f}')
          "

      # === IP Pillar 3: Compression Codec ===
      - name: "Test: ANS Codec Roundtrip"
        run: |
          python -c "
          from algorithms.rft.compression.ans import ans_encode, ans_decode
          symbols = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
          encoded, freq_data = ans_encode(symbols)
          decoded = ans_decode(encoded, freq_data, len(symbols))
          assert decoded == symbols, f'ANS roundtrip failed'
          print(f'✓ ANS Codec: Roundtrip OK, {len(encoded)*2} bytes')
          "

      - name: "Test: H3 Hypothesis Results Reproducible"
        run: |
          python -c "
          # Run the exact experiment that produced the claimed results
          import subprocess
          result = subprocess.run(
              ['python', 'experiments/ascii_wall/ascii_wall_final_hypotheses.py'],
              capture_output=True, text=True, timeout=120
          )
          output = result.stdout + result.stderr
          # Verify key metrics are present
          assert 'H3_Baseline_Cascade' in output, 'H3 test not found'
          assert 'PSNR' in output, 'PSNR metric not found'
          assert 'Coherence: 0.00e+00' in output, 'Zero coherence not achieved'
          assert 'BPP: 0.8' in output, 'Expected BPP range not found'
          print('✓ H3 Hypothesis Testing: Reproducible')
          "

      # === IP Pillar 4: Crypto Avalanche ===
      - name: "Test: Crypto Avalanche (~50%)"
        run: |
          python -c "
          from algorithms.rft.crypto.enhanced_cipher import EnhancedRFTCryptoV2
          import secrets
          key = secrets.token_bytes(32)
          cipher = EnhancedRFTCryptoV2(master_key=key)
          pt = b'Test message for avalanche analysis - need 128 bits minimum'
          ct1 = cipher.encrypt_aead(pt)
          pt2 = bytearray(pt); pt2[0] ^= 0x01
          ct2 = cipher.encrypt_aead(bytes(pt2))
          min_len = min(len(ct1), len(ct2))
          diff = sum(bin(ct1[i] ^ ct2[i]).count('1') for i in range(min_len))
          avalanche = diff / (min_len * 8)
          assert 0.4 < avalanche < 0.6, f'Avalanche out of range: {avalanche*100:.1f}%'
          print(f'✓ Crypto Avalanche: {avalanche*100:.1f}%')
          "

      # === Full Test Suite ===
      - name: Run RFT correctness tests (43 tests)
        run: |
          pytest tests/transforms/test_rft_correctness.py -v --tb=short
      
      - name: Run codec tests
        run: |
          pytest tests/codec_tests/ -v --tb=short

  # Build verification
  build:
    name: Build Package
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30

  # Docker build verification
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: quantoniumos:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          docker run --rm quantoniumos:test python --version
          docker run --rm quantoniumos:test python -c "import numpy; print('NumPy:', numpy.__version__)"
